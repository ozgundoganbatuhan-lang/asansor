generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  vertical  Vertical @default(ELEVATOR)
  planTier  String   @default("TRIAL")
  trialEndsAt DateTime @default(dbgenerated("NOW() + INTERVAL '30 days'"))
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  customers        Customer[]
  assets           Asset[]
  workOrders       WorkOrder[]
  technicians      Technician[]
  parts            Part[]
  invoices         Invoice[]
  maintenancePlans MaintenancePlan[]
  purchaseRequests PurchaseRequest[]
  contracts        Contract[]
  inspections      Inspection[]
  brands           Brand[]
  devices          Device[]
  serviceCalls     ServiceCall[]
  serviceInvoices  ServiceInvoice[]
}

enum Vertical {
  ELEVATOR
  WHITE_GOODS
}

model User {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String?
  email          String   @unique
  passwordHash   String
  role           String   @default("MEMBER")
  createdAt      DateTime @default(now())
}

model Customer {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  contactName    String?
  phone          String?
  email          String?
  address        String?
  taxId          String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  assets     Asset[]
  workOrders WorkOrder[]
  invoices   Invoice[]
  contracts  Contract[]
  devices    Device[]
  serviceCalls ServiceCall[]
  serviceInvoices ServiceInvoice[]
}

model Asset {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])

  name            String
  elevatorIdNo    String?  // Asansör Kimlik Numarası (yönetmelik zorunlu)
  category        String?
  serialNumber    String?
  brand           String?
  buildingName    String?
  doorNumber      String?
  locationNote    String?
  stops           Int?
  capacityKg      Int?
  speed           Float?   // m/s
  driveType       String?  // Elektrikli, Hidrolik
  controllerBrand String?
  installYear     Int?
  lastRevisionYear Int?
  riskScore       Int?     @default(0)
  lastMaintenanceAt DateTime?
  lastInspectionAt  DateTime?
  nextInspectionAt  DateTime?
  inspectionLabel   String?  // YESIL, MAVI, SARI, KIRMIZI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrders       WorkOrder[]
  maintenancePlans MaintenancePlan[]
  contractAssets   ContractAsset[]
  inspections      Inspection[]
}

model Technician {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  initials       String?
  phone          String?
  zone           String?
  certification  String?
  status         String?  @default("Müsait")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workOrders WorkOrder[]
  serviceCalls ServiceCall[] @relation("ServiceCallTechnician")
}

model WorkOrder {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])
  assetId        String?
  asset          Asset?   @relation(fields: [assetId], references: [id])
  technicianId   String?
  technician     Technician? @relation(fields: [technicianId], references: [id])

  code        String   @unique
  type        WorkOrderType @default(FAULT)
  status      WorkOrderStatus @default(PENDING)
  priority    String?  @default("Normal")
  note        String?
  laborCost   Int      @default(0)
  serviceFee  Int      @default(0)
  scheduledAt DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  partsUsed PartUsage[]
  invoice   Invoice?
}

enum WorkOrderType {
  FAULT
  PERIODIC_MAINTENANCE
  ANNUAL_INSPECTION
  REVISION
  INSTALLATION
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  URGENT
  DONE
  CANCELED
}

model MaintenancePlan {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  assetId        String
  asset          Asset    @relation(fields: [assetId], references: [id])
  name           String?
  planType       String   @default("PERIODIC") // PERIODIC, ANNUAL_INSPECTION, CUSTOM
  periodDays     Int      @default(30)  // özel gün sayısı (eski periodMonths yerine)
  periodMonths   Int?     // geriye dönük uyumluluk
  monthlyFee     Int      @default(0)
  contractId     String?
  contract       Contract? @relation(fields: [contractId], references: [id])
  technicianId   String?
  lastDoneAt     DateTime?
  nextDueAt      DateTime
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Part {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  category       String?
  unit           String?  @default("Adet")
  supplier       String?
  price          Int?
  stock          Int      @default(0)
  minStock       Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  usages PartUsage[]
  serviceUsages ServicePartUsage[] @relation("ServicePartUsagePart")
}

model PartUsage {
  id          String    @id @default(cuid())
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
  partId      String
  part        Part      @relation(fields: [partId], references: [id])
  quantity    Int       @default(1)
  createdAt   DateTime  @default(now())
}

model Invoice {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  workOrderId    String   @unique
  workOrder      WorkOrder @relation(fields: [workOrderId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])

  number    String   @unique
  status    InvoiceStatus @default(DRAFT)
  currency  String   @default("TRY")
  subtotal  Int      @default(0)
  taxRate   Int      @default(2000)
  taxAmount Int      @default(0)
  total     Int      @default(0)
  notes     String?
  issuedAt  DateTime @default(now())
  dueAt     DateTime?
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  VOID
}

model PurchaseRequest {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  fullName       String
  email          String
  phone          String
  monthlyJobs    Int?
  technicianCount Int?
  city           String?
  note           String?
  status         String   @default("PENDING")
  createdAt      DateTime @default(now())
}

// ─── V11 ADDITIONS ─────────────────────────────────────────────────────────

model Contract {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])

  // Yasal zorunlu alanlar (Asansör İşletme ve Bakım Yönetmeliği)
  contractNumber    String?
  startDate         DateTime
  endDate           DateTime?
  autoRenew         Boolean  @default(true)
  monthlyFee        Int      @default(0) // kuruş cinsinden
  currency          String   @default("TRY")

  // Teknik sorumlu (yönetmelik gereği sözleşmede zorunlu)
  technicianName    String?
  technicianCert    String?  // TSE belge no

  // Şifreleme/kısıtlama beyanı (2019 yönetmeliği zorunlu kılıyor)
  hasEncryptionDevice Boolean @default(false)
  encryptionNote    String?

  status  ContractStatus @default(ACTIVE)
  notes   String?
  fileUrl String?  // upload edilen PDF

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assets      ContractAsset[]
  maintenancePlans MaintenancePlan[]
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

// Sözleşme ↔ Asansör many-to-many (bir sözleşme birden fazla asansörü kapsayabilir)
model ContractAsset {
  id         String   @id @default(cuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])
  assetId    String
  asset      Asset    @relation(fields: [assetId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([contractId, assetId])
}

// TSE / A Tipi Muayene Kuruluşu periyodik kontrol takibi
model Inspection {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  assetId        String
  asset          Asset    @relation(fields: [assetId], references: [id])

  inspectionDate   DateTime
  nextDueDate      DateTime  // genellikle +1 yıl
  inspectionBody   String?   // TSE, SZUTEST, AND Muayene vs.
  inspectorName    String?
  result           InspectionResult @default(UYGUNSUZLUK_YOK)
  label            InspectionLabel  @default(YESIL)
  deficiencies     String?   // tespit edilen eksiklikler
  reportUrl        String?   // yüklenen PDF rapor
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InspectionResult {
  UYGUNSUZLUK_YOK   // Yeşil etiket
  HAFIF_KUSURLU     // Mavi etiket
  KUSURLU           // Sarı etiket
  GUVENSIZ          // Kırmızı etiket
}

enum InspectionLabel {
  YESIL   // Kusursuz
  MAVI    // Hafif kusurlu (120 gün içinde düzeltilmeli)
  SARI    // Kusurlu
  KIRMIZI // Güvensiz - 30 gün içinde durdurulacak
}

// ═══════════════════════════════════════════════════════════════
// BEYAZ EŞYA SERVİS MODÜLÜ — V12
// Yasal Dayanak: 6502 TKHK, Garanti Belgesi Yönetmeliği, TS 12354
// ═══════════════════════════════════════════════════════════════

// Marka ve yetkili servis yetki belgesi
model Brand {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String        // Arçelik, Bosch, Samsung...
  authCode       String?       // Yetkili servis kodu
  authStartDate  DateTime?     // Yetki başlangıcı
  authEndDate    DateTime?     // Yetki bitiş (yenileme uyarısı)
  contactName    String?       // Marka yetkili kişi
  contactPhone   String?
  contactEmail   String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  devices   Device[]
}

// Beyaz eşya cihaz kaydı
model Device {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])
  brandId        String?
  brand          Brand?   @relation(fields: [brandId], references: [id])

  // Cihaz kimliği
  category       DeviceCategory
  modelName      String?        // Model adı (WMB 91432, vb.)
  modelCode      String?        // Model kodu
  serialNumber   String?        // Seri no (garanti için zorunlu)
  productionYear Int?
  color          String?

  // Kurulum
  purchaseDate   DateTime?      // Satın alma tarihi (garanti başlangıcı)
  purchasePlace  String?        // Satın alınan yer
  invoiceNumber  String?        // Fatura no (garanti belgesi için)
  installDate    DateTime?      // Kurulum tarihi
  locationNote   String?        // Cihazın konumu: mutfak, çamaşırhane...

  // Garanti takibi (6502 TKHK - min 2 yıl)
  warrantyYears  Int      @default(2)
  warrantyEndDate DateTime?     // Otomatik hesaplanır: purchaseDate + warrantyYears
  extendedWarranty Boolean @default(false)
  extendedWarrantyEnd DateTime?

  // Teknik bilgiler
  powerWatts     Int?
  voltage        String?        // 220V, 380V
  capacity       String?        // 8kg, 500L, vb.
  energyClass    String?        // A+++, A++

  // Servis geçmişi özeti
  lastServiceAt  DateTime?
  totalServiceCount Int @default(0)
  isUnderRepair  Boolean @default(false)

  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  serviceCalls ServiceCall[]
}

enum DeviceCategory {
  WASHING_MACHINE       // Çamaşır Makinesi
  DRYER                 // Kurutucu
  WASHER_DRYER          // Kurutmalı Çamaşır
  DISHWASHER            // Bulaşık Makinesi
  REFRIGERATOR          // Buzdolabı
  FREEZER               // Derin Dondurucu
  FRIDGE_FREEZER        // Kombi
  OVEN                  // Fırın
  COOKTOP               // Ocak
  RANGE_HOOD            // Davlumbaz
  MICROWAVE             // Mikrodalga
  AIR_CONDITIONER       // Klima
  WATER_HEATER          // Şofben/Kombi
  VACUUM_CLEANER        // Süpürge
  SMALL_APPLIANCE       // Küçük Ev Aleti
  OTHER                 // Diğer
}

// Servis çağrısı — 6502 TKHK ve TS 12354 uyumlu
model ServiceCall {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])
  deviceId       String
  device         Device   @relation(fields: [deviceId], references: [id])
  technicianId   String?
  technician     Technician? @relation(fields: [technicianId], references: [id], name: "ServiceCallTechnician")

  // Çağrı kimliği
  code           String   @unique  // SRV-2025-0001

  // Çağrı türü ve durumu
  callType       ServiceCallType    @default(FAULT_REPAIR)
  status         ServiceCallStatus  @default(RECEIVED)
  priority       ServicePriority    @default(NORMAL)

  // Garanti durumu (6502 TKHK)
  warrantyStatus WarrantyStatus @default(UNKNOWN)
  isUnderWarranty Boolean @default(false)  // garanti kapsamında mı

  // Arıza bilgisi
  faultDescription String?   // Müşteri şikayeti
  faultDiagnosis   String?   // Teknisyen teşhisi
  faultCode        String?   // Hata kodu (varsa)
  repairDescription String?  // Yapılan işlem

  // Zaman takibi — 30 iş günü yasal limit (6502 TKHK Md. 13)
  receivedAt     DateTime  @default(now())  // Çağrı alındı
  scheduledAt    DateTime?                  // Randevu zamanı
  technicianArrivedAt DateTime?             // Teknisyen vardı
  repairStartedAt DateTime?                 // Tamir başladı
  completedAt    DateTime?                  // Tamamlandı
  workingDaysUsed Int?                      // Kullanılan iş günü

  // Konum
  visitType      VisitType @default(HOME_VISIT)  // Ev ziyareti / Atölyeye al
  address        String?   // Adres (ev ziyareti için)

  // Maliyetler
  laborCost      Int   @default(0)  // İşçilik (kuruş)
  transportCost  Int   @default(0)  // Yol/taşıma
  diagnosticFee  Int   @default(0)  // Teşhis ücreti
  isWarrantyCovered Boolean @default(false)  // Garanti kapsamı

  // 6502 Yasal bildirimler
  customerInformed Boolean @default(false)   // Müşteri bilgilendirme yapıldı mı
  rightToReplace   Boolean @default(false)   // Değişim hakkı doğdu mu (30 gün aşıldı)
  rightToRefund    Boolean @default(false)   // İade hakkı doğdu mu

  notes          String?
  internalNotes  String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  partsUsed      ServicePartUsage[]
  invoice        ServiceInvoice?
}

enum ServiceCallType {
  FAULT_REPAIR          // Arıza Tamiri
  WARRANTY_REPAIR       // Garanti Tamiri
  PERIODIC_MAINTENANCE  // Periyodik Bakım
  INSTALLATION          // Kurulum/Montaj
  UNINSTALLATION        // Söküm
  TECHNICAL_INSPECTION  // Teknik Kontrol
  CUSTOMER_MISUSE       // Kullanım Hatası
  SPARE_PART_SUPPLY     // Yedek Parça Temini
}

enum ServiceCallStatus {
  RECEIVED        // Çağrı Alındı
  SCHEDULED       // Randevu Verildi
  TECHNICIAN_WAY  // Teknisyen Yolda
  IN_PROGRESS     // İşlem Devam Ediyor
  WAITING_PARTS   // Parça Bekleniyor
  WAITING_APPROVAL // Müşteri Onayı Bekleniyor
  COMPLETED       // Tamamlandı
  CANNOT_REPAIR   // Tamir Edilemez
  CANCELED        // İptal
}

enum ServicePriority {
  URGENT    // Acil
  HIGH      // Yüksek
  NORMAL    // Normal
  LOW       // Düşük
}

enum WarrantyStatus {
  IN_WARRANTY       // Garanti İçi
  OUT_OF_WARRANTY   // Garanti Dışı
  EXTENDED_WARRANTY // Uzatılmış Garanti
  UNKNOWN           // Bilinmiyor
}

enum VisitType {
  HOME_VISIT    // Ev/İşyeri Ziyareti
  WORKSHOP      // Atölyeye Getirme
  REMOTE        // Uzaktan Destek
}

// Serviste kullanılan parçalar
model ServicePartUsage {
  id            String   @id @default(cuid())
  serviceCallId String
  serviceCall   ServiceCall @relation(fields: [serviceCallId], references: [id])
  partId        String
  part          Part     @relation(fields: [partId], references: [id], name: "ServicePartUsagePart")
  quantity      Int      @default(1)
  unitPrice     Int      @default(0)   // Satış fiyatı (kuruş)
  isWarrantyCovered Boolean @default(false)
  createdAt     DateTime @default(now())
}

// Servis faturası (PartUsage'dan bağımsız)
model ServiceInvoice {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  serviceCallId  String   @unique
  serviceCall    ServiceCall @relation(fields: [serviceCallId], references: [id])
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])

  number         String   @unique
  status         ServiceInvoiceStatus @default(DRAFT)
  currency       String   @default("TRY")
  subtotal       Int      @default(0)
  taxRate        Int      @default(2000)  // 20.00%
  taxAmount      Int      @default(0)
  total          Int      @default(0)
  notes          String?
  issuedAt       DateTime @default(now())
  dueAt          DateTime?
  paidAt         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum ServiceInvoiceStatus {
  DRAFT
  SENT
  PAID
  VOID
}
